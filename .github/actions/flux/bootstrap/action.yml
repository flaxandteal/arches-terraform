

name: "Bootstrap Flux in GKE"
description: "Installs Flux into a GKE cluster."
inputs:
  gcp_project:
    description: "GCP project ID"
    required: true
  gke_cluster:
    description: "GKE cluster name"
    required: true
  gke_region:
    description: "Region of the GKE cluster"
    required: true
  github_token:
    description: "GitHub token for Flux bootstrap"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ inputs.gcp_project }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}

    - name: Connect to GKE
      run: |
        gcloud container clusters get-credentials ${{ inputs.gke_cluster }} --region=${{ inputs.gke_region }}
      shell: bash

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init & Apply
      run: |
        terraform -chdir=infra init
        terraform -chdir=infra apply -auto-approve
      shell: bash

    - name: Install Flux CLI
      run: |
        curl -s https://fluxcd.io/install.sh | sudo bash
      shell: bash

    - name: Check for Existing Flux Installation
      id: check-flux
      run: |
        if kubectl get ns flux-system >/dev/null 2>&1; then
          echo "Flux already installed."
          echo "already=true" >> $GITHUB_OUTPUT
        else
          echo "already=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Bootstrap Flux
      if: steps.check-flux.outputs.already == 'false'
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: ./github/actions/flux/bootstrap.sh
      shell: bash

    - name: Verify Flux Installation    
      shell: bash    
      run: |
          flux check --pre
          flux get all
          kubectl get pods -n flux-system
          echo "✅Flux installation and bootstrap completed successfully."

    - name: Cleanup
      shell: bash
      run: |
        echo "Cleaning up temporary files..."
        rm -rf /tmp/flux-bootstrap
        echo "Cleanup completed."

    - name: Notify Success
      shell: bash
      run: |
        echo "✅Flux has been successfully installed and bootstrapped."

    - name: Notify Failure
      shell: bash
      if: failure()
      run: |
        echo "❌Flux installation failed. Please check the logs for details."
        exit 1